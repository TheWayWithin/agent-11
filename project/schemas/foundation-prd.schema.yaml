# PRD (Product Requirements Document) Extraction Schema
# Purpose: Structured data for agents to implement features correctly
# Usage: /foundations init extracts source docs to this format
# Mode: COMPLETENESS MODE - extract 100% of all data

$schema: "http://json-schema.org/draft-07/schema#"
type: object
description: "Structured product requirements for agent consumption"

required:
  - product
  - problem
  - users
  - features

properties:
  product:
    type: object
    required: [name, tagline, type]
    properties:
      name:
        type: string
        description: "Product name"
      tagline:
        type: string
        description: "One-line description"
      type:
        type: string
        description: "Product type (SaaS, API, Mobile, etc.)"
      website:
        type: string
        description: "Domain or URL"
      version:
        type: string
        description: "Current version if applicable"

  problem:
    type: object
    required: [core]
    properties:
      core:
        type: string
        description: "The core problem being solved"
      symptoms:
        type: array
        items:
          type: string
        description: "Observable symptoms of the problem"
      cycle:
        type: array
        items:
          type: string
        description: "The negative cycle users experience"
      cost:
        type: string
        description: "What the problem costs users (time, money, frustration)"

  users:
    type: array
    items:
      type: object
      required: [profile, priority]
      properties:
        profile:
          type: string
          description: "User profile name"
        priority:
          type: integer
          description: "1=primary, 2=secondary, etc."
        products:
          type: string
          description: "Number of products they manage"
        mrr_range:
          type: string
          description: "Typical MRR range"
        pain_points:
          type: array
          items:
            type: string
        success_looks_like:
          type: string

  features:
    type: object
    properties:
      p0_must_have:
        type: array
        description: "Launch blockers - MVP requirements"
        items:
          type: object
          required: [name]
          properties:
            id:
              type: string
              description: "Feature identifier (e.g., 'F-001')"
            name:
              type: string
            description:
              type: string
            sub_features:
              type: array
              description: "CRITICAL: Extract ALL comma-separated components"
              items:
                type: string
            acceptance_criteria:
              type: array
              description: "Given/When/Then format preferred"
              items:
                type: string
            success_metric:
              type: string
            dependencies:
              type: array
              items:
                type: string
            touched_entities:
              type: array
              description: "Data model entities this feature interacts with"
              items:
                type: string
            related_business_rules:
              type: array
              description: "Business rules that apply to this feature"
              items:
                type: string
      p1_should_have:
        type: array
        description: "Important but not launch blocking"
        items:
          $ref: "#/properties/features/properties/p0_must_have/items"
      p2_nice_to_have:
        type: array
        description: "Future enhancements"
        items:
          $ref: "#/properties/features/properties/p0_must_have/items"

  phases:
    type: array
    description: "Development phases with timelines and deliverables"
    items:
      type: object
      required: [name, timeline, deliverables]
      properties:
        name:
          type: string
          description: "Phase name (e.g., 'MVP Foundation')"
        number:
          type: integer
          description: "Phase number (1, 2, 3, etc.)"
        timeline:
          type: object
          required: [start, end]
          properties:
            start:
              type: string
              description: "Start week/date (e.g., 'Week 1')"
            end:
              type: string
              description: "End week/date (e.g., 'Week 6')"
            duration:
              type: string
              description: "Duration (e.g., '6 weeks')"
        deliverables:
          type: array
          description: "ALL deliverables - NEVER truncate this list"
          items:
            type: string
        deliverables_list:
          type: array
          description: "ENHANCED: Structured deliverables with acceptance criteria"
          items:
            type: object
            required: [item, type, acceptance]
            properties:
              item:
                type: string
                description: "Deliverable name (e.g., 'User authentication system')"
              type:
                type: string
                enum: ["code", "database", "integration", "infrastructure", "design", "documentation", "test"]
                description: "Deliverable category"
              acceptance:
                type: string
                description: "How we know it's done (e.g., 'User can sign up/login')"
              dependencies:
                type: array
                items:
                  type: string
                description: "Other deliverables this depends on"
        milestone:
          type: string
          description: "Key milestone at phase end"

  tech_stack:
    type: object
    description: "Technology choices with versions and features"
    properties:
      frontend:
        type: object
        properties:
          name:
            type: string
          version:
            type: string
          features:
            type: array
            items:
              type: string
      backend:
        type: object
        properties:
          name:
            type: string
          version:
            type: string
          features:
            type: array
            items:
              type: string
      database:
        type: object
        properties:
          name:
            type: string
          features:
            type: array
            items:
              type: string
            description: "e.g., ['RLS', 'Edge Functions']"
      auth:
        type: string
      hosting:
        type: object
        properties:
          frontend:
            type: string
          backend:
            type: string
      email:
        type: string
      payments:
        type: string
      ai_models:
        type: array
        description: "ALL supported AI models with providers"
        items:
          type: object
          properties:
            name:
              type: string
              description: "Model name (e.g., 'GPT-4', 'GPT-4o', 'Claude')"
            provider:
              type: string
              description: "Provider (e.g., 'OpenAI', 'Anthropic')"
      queues:
        type: string
      analytics:
        type: string

  success_metrics:
    type: array
    description: "ALL metrics with numeric targets - NEVER omit values"
    items:
      type: object
      required: [metric, target]
      properties:
        metric:
          type: string
        target:
          oneOf:
            - type: number
            - type: string
          description: "Numeric target value (1000, not 'many')"
        unit:
          type: string
          description: "Unit (users, USD, percent, etc.)"
        timeframe:
          type: string
          description: "When to achieve (e.g., '3 months')"
        source_quote:
          type: string
          description: "Original text from source document"

  non_functional_requirements:
    type: object
    description: "Performance, security, and scalability requirements"
    properties:
      performance:
        type: array
        description: "ALL performance SLAs with numeric values"
        items:
          type: object
          properties:
            requirement:
              type: string
            target:
              type: string
              description: "Exact value (e.g., '99.9%', '<5s', '10K')"
            unit:
              type: string
      security:
        type: array
        description: "ALL security requirements"
        items:
          type: string
      scalability:
        type: array
        description: "ALL scalability requirements"
        items:
          type: string
      compliance:
        type: array
        items:
          type: string

  constraints:
    type: object
    properties:
      technical:
        type: array
        items:
          type: string
      business:
        type: array
        items:
          type: string
      timeline:
        type: string
      budget:
        type: string

  pricing:
    type: object
    properties:
      model:
        type: string
        description: "Pricing model (subscription, usage, freemium)"
      tiers:
        type: array
        items:
          type: object
          properties:
            name:
              type: string
            price:
              type: object
              properties:
                amount:
                  type: number
                period:
                  type: string
                currency:
                  type: string
            features:
              type: array
              items:
                type: string
            limits:
              type: object

  # ============================================================
  # ENHANCED SECTIONS (Added for comprehensive PRD extraction)
  # ============================================================

  glossary:
    type: array
    description: "Domain-specific terms and their definitions for consistent understanding"
    items:
      type: object
      required: [term, definition]
      properties:
        term:
          type: string
          description: "The term being defined"
        definition:
          type: string
          description: "Clear, concise definition"
        aliases:
          type: array
          items:
            type: string
          description: "Alternative names or abbreviations"
        examples:
          type: array
          items:
            type: string
          description: "Example usages or instances"

  state_machines:
    type: array
    description: "Entity lifecycle states and valid transitions - CRITICAL for implementation"
    items:
      type: object
      required: [name, entity, states, transitions]
      properties:
        name:
          type: string
          description: "State machine name (e.g., 'Subscription State Machine')"
        entity:
          type: string
          description: "The entity this state machine governs"
        states:
          type: array
          items:
            type: object
            required: [name]
            properties:
              name:
                type: string
                description: "State name (e.g., 'trial', 'active', 'cancelled')"
              description:
                type: string
                description: "What this state represents"
              entry_conditions:
                type: array
                items:
                  type: string
                description: "Conditions that must be true to enter this state"
              exit_conditions:
                type: array
                items:
                  type: string
                description: "Conditions that must be true to exit this state"
        transitions:
          type: array
          items:
            type: object
            required: [from, to, trigger]
            properties:
              from:
                type: string
                description: "Source state"
              to:
                type: string
                description: "Destination state"
              trigger:
                type: string
                description: "Event that triggers this transition"
              guard_conditions:
                type: array
                items:
                  type: string
                description: "Additional conditions that must be true"
              side_effects:
                type: array
                items:
                  type: string
                description: "Actions performed during transition"

  critical_journeys:
    type: array
    description: "End-to-end user flows that MUST work - use for E2E testing"
    items:
      type: object
      required: [id, name, steps]
      properties:
        id:
          type: string
          description: "Journey identifier (e.g., 'CJ-001')"
        name:
          type: string
          description: "Journey name (e.g., 'New User to First Insight')"
        description:
          type: string
          description: "What this journey accomplishes"
        preconditions:
          type: array
          items:
            type: string
          description: "State that must exist before journey starts"
        steps:
          type: array
          items:
            type: object
            required: [step, action]
            properties:
              step:
                type: integer
                description: "Step number in sequence"
              action:
                type: string
                description: "What the user does"
              expected_result:
                type: string
                description: "What should happen"
              touched_entities:
                type: array
                items:
                  type: string
                description: "Data entities affected by this step"
        postconditions:
          type: array
          items:
            type: string
          description: "State that must exist after journey completes"
        success_metric:
          type: string
          description: "How to measure journey success"

  edge_cases:
    type: array
    description: "Boundary conditions and error scenarios - CRITICAL for robust implementation"
    items:
      type: object
      required: [category, scenario, expected_behavior]
      properties:
        id:
          type: string
          description: "Edge case identifier (e.g., 'EC-001')"
        category:
          type: string
          enum: ["tier_limits", "authentication", "payment", "data", "concurrency", "integration", "validation"]
          description: "Type of edge case"
        scenario:
          type: string
          description: "The specific edge case scenario"
        trigger:
          type: string
          description: "What causes this edge case"
        expected_behavior:
          type: string
          description: "How the system should handle it"
        error_message:
          type: string
          description: "User-facing error message if applicable"
        related_business_rule:
          type: string
          description: "Reference to relevant business rule (e.g., 'BR-001')"

  integration_tests:
    type: array
    description: "Cross-component test scenarios - ensures features work together"
    items:
      type: object
      required: [id, name, components, scenario]
      properties:
        id:
          type: string
          description: "Test identifier (e.g., 'IT-001')"
        name:
          type: string
          description: "Test name"
        components:
          type: array
          items:
            type: string
          description: "Components/features being tested together"
        preconditions:
          type: array
          items:
            type: string
          description: "Setup required before test"
        scenario:
          type: string
          description: "The integration scenario being tested"
        steps:
          type: array
          items:
            type: string
          description: "Test steps"
        expected_outcome:
          type: string
          description: "What success looks like"
        data_flow:
          type: string
          description: "How data moves between components"

  success_criteria_by_tier:
    type: object
    description: "Success metrics broken down by pricing tier"
    properties:
      free_trial:
        type: object
        properties:
          activation_criteria:
            type: array
            items:
              type: string
          conversion_target:
            type: string
          key_actions:
            type: array
            items:
              type: string
      starter:
        type: object
        properties:
          retention_target:
            type: string
          upgrade_signals:
            type: array
            items:
              type: string
          key_metrics:
            type: array
            items:
              type: string
      professional:
        type: object
        properties:
          retention_target:
            type: string
          expansion_signals:
            type: array
            items:
              type: string
          key_metrics:
            type: array
            items:
              type: string
      team:
        type: object
        properties:
          retention_target:
            type: string
          key_metrics:
            type: array
            items:
              type: string

  additional_compliance:
    type: object
    description: "Privacy, data handling, and regulatory compliance requirements"
    properties:
      data_privacy:
        type: array
        description: "Data privacy requirements beyond standard compliance"
        items:
          type: object
          properties:
            requirement:
              type: string
            implementation:
              type: string
            user_control:
              type: string
      third_party_integrations:
        type: array
        description: "Compliance requirements for external service integrations"
        items:
          type: object
          properties:
            service:
              type: string
            data_shared:
              type: array
              items:
                type: string
            dpa_required:
              type: boolean
            user_disclosure:
              type: string
      audit_requirements:
        type: array
        description: "Logging and audit trail requirements"
        items:
          type: object
          properties:
            event_type:
              type: string
            data_captured:
              type: array
              items:
                type: string
            retention_period:
              type: string

  business_rules:
    type: array
    description: "ALL business rules with enforcement locations - NEVER omit any rules"
    items:
      type: object
      required: [id, rule, enforcement]
      properties:
        id:
          type: string
          description: "Rule identifier (e.g., 'BR-001')"
        category:
          type: string
          enum: ["limits", "access", "billing", "data", "notifications", "security"]
          description: "Rule category"
        rule:
          type: string
          description: "The business rule statement"
        enforcement:
          type: array
          items:
            type: string
          description: "Where/how this rule is enforced (e.g., 'API middleware', 'Database constraint')"
        exceptions:
          type: array
          items:
            type: string
          description: "Any exceptions to this rule"
        related_features:
          type: array
          items:
            type: string
          description: "Features that depend on this rule"

  data_model:
    type: object
    description: "Complete data model with ALL entities - cross-reference with features"
    properties:
      entities:
        type: array
        items:
          type: object
          required: [name, attributes]
          properties:
            name:
              type: string
              description: "Entity name (e.g., 'User', 'Subscription', 'Product')"
            description:
              type: string
              description: "What this entity represents"
            attributes:
              type: array
              items:
                type: object
                required: [name, type]
                properties:
                  name:
                    type: string
                  type:
                    type: string
                  required:
                    type: boolean
                  description:
                    type: string
                  constraints:
                    type: array
                    items:
                      type: string
            relationships:
              type: array
              items:
                type: object
                properties:
                  entity:
                    type: string
                  type:
                    type: string
                    enum: ["one-to-one", "one-to-many", "many-to-many"]
                  description:
                    type: string